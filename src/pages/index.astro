---
import Head from "../components/core/head.astro";
import Login from "../components/login.astro";
import Navbar from "../components/core/navbar.astro";
import { MongoDB } from "../lib/mongodb";
import RightNav from "../components/core/rightNav.astro";
import SearchNav from "../components/core/searchNav";
import ContainerMovieCard from "../components/containerMovieCard.astro";
import MovieCard from "../components/movieCard.astro";

const topFilms = (await new MongoDB("films").getTopFilms()) || [];

// Prompt
const {prompt} = Astro.locals

// Login POST
let err;
let dumpForm;
if(Astro.request.method == "POST"){
  const form = Object.fromEntries(await Astro.request.formData())
  const validAcc = await new MongoDB("accounts").checkAccount(form.email, form.pass);  
  if(!validAcc){
    err = "Email atau Password Anda Salah!"
    dumpForm = form
  } else {
    const session = await new MongoDB("sessions").createSession(validAcc._id)    
    Astro.cookies.set("sessionID", `${session}`, {
      path:"/",
      httpOnly: true,
      secure: import.meta.env.PROD,
      sameSite: 'strict',
      maxAge: 60 * 60
    })
    try{
      const from = new URL(Astro.request.url).searchParams.get('from') 
      if(from) return Astro.redirect(from)
      return Astro.redirect("/")
    } catch {
      return Astro.redirect("/")
    }
  }
}
---

<html lang="id-ID">
  <head>
    <Head title="UrEyes - Daftar Film Dunia" />
  </head>
  <body class="scroll-smooth bg-linear-to-b from-bg-top to-bg-btm min-h-screen flex flex-col">
    {prompt !== "needLogin" && (

      <Navbar>
      <RightNav>
        <SearchNav client:load />
      </RightNav>
    </Navbar>

    <header class="relative h-[80vh] w-full flex items-center justify-start overflow-hidden mb-16">
      <div class="absolute inset-0 z-0">
        <img src={topFilms[0].bannerUri} alt="Hero Movie" class="w-full h-full object-cover" />
        <div class="absolute inset-0 bg-linear-to-t from-bg-btm via-bgfrom-bg-btm/50 to-transparent"></div>
        <div class="absolute inset-0 bg-linear-to-r from-bg-btm via-bgfrom-bg-btm/30 to-transparent"></div>
      </div>

      <div class="relative z-10 max-w-7xl mx-auto px-5 w-full pt-20">
        <span class="text-bg-top font-bold tracking-wider text-sm uppercase mb-4">Sedang Tren #1</span>
        <h1 class="text-5xl md:text-7xl font-bold mb-2 leading-tight text-transparent bg-clip-text bg-linear-to-r from-bg-top to-white">{topFilms[0].judul}</h1>
        <div class="max-w-32 backdrop-blur-sm px-2 py-1 mb-4 rounded-2xl text-xl font-bold text-yellow-400 flex justify-center items-center gap-1 border border-white/10">
          <span>★</span> {topFilms[0].rating} <span class="text-white/60 ps-2">/ 10</span>
        </div>
        <p class="text-gray-300 max-w-xl text-base lg:text-lg mb-8 line-clamp-3">{topFilms[0].deskripsi}</p>

        <div class="flex flex-wrap gap-4">
          <a href={"/films/"+topFilms[0]._id} class="bg-btn hover:bg-bg-top text-white px-8 py-3 rounded-xl font-bold flex items-center gap-2 transition-transform hover:scale-105 shadow-lg shadow-bg-top/20"> Selengkapnya </a>
        </div>
      </div>
    </header>

    <main class="max-w-7xl w-full px-12 relative space-y-12">
      <!-- Section 1: Populer -->
      <ContainerMovieCard title="Populer Saat Ini">
        {topFilms.map((data) => <MovieCard data={data} />)}
      </ContainerMovieCard>

      <!-- Section 2: UR-EYES Originals -->
      <div>
        <h3 class="text-xl font-bold text-white mb-4 pl-2 border-l-4 border-bg-top">Originals Database</h3>
        <div class="flex gap-4 overflow-x-auto pb-4 snap-x">
          <div class="flex-none w-64 md:w-80 group relative cursor-pointer snap-start">
            <div class="aspect-video rounded-lg overflow-hidden bg-gray-800 relative border border-white/10 shadow-lg">
              <img src="https://images.unsplash.com/photo-1626814026160-2237a95fc5a0?q=80&w=2070&auto=format&fit=crop" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />
              <!-- Gradient bawah untuk teks -->
              <div class="absolute inset-0 bg-linear-to-t from-black via-transparent to-transparent"></div>

              <!-- Rating Badge Pojok Kiri Atas -->
              <div class="absolute top-3 left-3 bg-bg-top text-white px-2 py-1 rounded text-xs font-bold shadow-lg">Rating: 8.8</div>

              <div class="absolute bottom-4 left-4">
                <h4 class="text-lg font-bold text-white">Cyber Horizon</h4>
                <span class="text-xs text-gray-300">Sci-Fi • 2024</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    )}

    {prompt == "needLogin" && (
      <Navbar></Navbar>
      <Login err={err} form={dumpForm}></Login>
    )}
  </body>
</html>
